<link rel="manifest" href="/manifest.json" />
<h1>Notifications</h1>

<script>
   window.vapidPublicKey = new Uint8Array(<%= Base64.urlsafe_decode64(File.read('./vapid_keys/public_key')).bytes %>)
   if (navigator.serviceWorker) {
      navigator.serviceWorker.register('/serviceworker.js')
        .then(function(reg) {
           navigator.serviceWorker.ready.then((serviceWorkerRegistration) => {
              serviceWorkerRegistration.pushManager
                .subscribe({
                   userVisibleOnly: true,
                   applicationServerKey: window.vapidPublicKey
                }).then(async function(sub) {
                 const data = await fetch('/webnotifications', {
                    method: 'POST',
                    headers: {
                       'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sub),
                 }).then(r => r.json());
                 console.log(data);
              });
           });

        });
   }
// Otherwise, no push webnotifications :(
   else {
      console.error('Service worker is not supported in this browser');
   }
</script>